name: Continuous Model Training

on:
  schedule:
    # Run every 2 hours (12 times per day)
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      training_mode:
        description: 'Training mode'
        required: false
        default: 'incremental'
        type: choice
        options:
          - full
          - incremental
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '50'
        type: string
      stock_count:
        description: 'Number of random stocks to train'
        required: false
        default: '5'
        type: string

env:
  PYTHON_VERSION: '3.11'
  WANDB_PROJECT: 'ara-ai'
  HF_REPO: 'MeridianAlgo/ARA.AI'

jobs:
  train-stock-models:
    name: Train Random Stock Models
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install wandb huggingface_hub

      - name: Pull existing models from Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi, hf_hub_download
          import os
          
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          # Create repo if it doesn't exist
          try:
              api.create_repo(repo_id='${{ env.HF_REPO }}', repo_type='model', exist_ok=True)
              print('✓ Repository ready')
          except Exception as e:
              print(f'Repository setup: {e}')
          
          # Try to download existing models
          try:
              os.makedirs('models', exist_ok=True)
              files = api.list_repo_files(repo_id='${{ env.HF_REPO }}')
              for file in files:
                  if file.endswith('.pt'):
                      print(f'Downloading {file}...')
                      hf_hub_download(
                          repo_id='${{ env.HF_REPO }}',
                          filename=file,
                          local_dir='.',
                          token=os.environ['HF_TOKEN']
                      )
              print(f'✓ Downloaded {len([f for f in files if f.endswith(\".pt\")])} existing models')
          except Exception as e:
              print(f'No existing models to download: {e}')
          "

      - name: Select random stock tickers
        id: select
        run: |
          STOCKS=$(python scripts/select_random_tickers.py --file all_tickers.txt --count ${{ github.event.inputs.stock_count || '5' }} --output-format comma | tail -n 1)
          echo "stocks=$STOCKS" >> $GITHUB_OUTPUT
          echo "Selected stocks: $STOCKS"

      - name: Train stock models
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          STOCKS="${{ steps.select.outputs.stocks }}"
          IFS=',' read -ra STOCK_ARRAY <<< "$STOCKS"
          
          for SYMBOL in "${STOCK_ARRAY[@]}"; do
            echo "=========================================="
            echo "Processing $SYMBOL"
            echo "=========================================="
            
            # Fetch data
            echo "Fetching data for $SYMBOL..."
            python scripts/fetch_training_data.py \
              --symbols "$SYMBOL" \
              --output-dir "data/stocks/$SYMBOL" \
              --period 2y \
              --asset-type stock || { echo "Failed to fetch $SYMBOL, skipping..."; continue; }
            
            # Store in database
            echo "Storing data for $SYMBOL..."
            python scripts/store_training_data.py \
              --data-dir "data/stocks/$SYMBOL" \
              --db-file "training_${SYMBOL}.db" \
              --mode ${{ github.event.inputs.training_mode || 'incremental' }} || { echo "Failed to store $SYMBOL, skipping..."; continue; }
            
            # Train model (incremental if model exists)
            echo "Training model for $SYMBOL..."
            INCREMENTAL_FLAG=""
            if [ -f "models/stock_${SYMBOL}.pt" ]; then
              INCREMENTAL_FLAG="--incremental"
              echo "Using incremental training (model exists)"
            fi
            
            python scripts/train_model.py \
              --symbol "$SYMBOL" \
              --db-file "training_${SYMBOL}.db" \
              --output "models/stock_${SYMBOL}.pt" \
              --epochs ${{ github.event.inputs.epochs || '50' }} \
              --use-all-data \
              $INCREMENTAL_FLAG \
              --wandb-project ${{ env.WANDB_PROJECT }} \
              --wandb-run-name "stock-${SYMBOL}-$(date +%Y%m%d-%H%M)" || { echo "Failed to train $SYMBOL, skipping..."; continue; }
            
            echo "✓ Successfully trained $SYMBOL"
          done

      - name: Upload trained models
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stock-models-${{ github.run_number }}
          path: models/stock_*.pt
          retention-days: 7
          if-no-files-found: warn

  train-forex-models:
    name: Train Forex Models
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        pair: [EURUSD, GBPUSD, USDJPY]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install wandb huggingface_hub

      - name: Pull existing forex model from Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi, hf_hub_download
          import os
          
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          # Try to download existing model
          try:
              os.makedirs('models', exist_ok=True)
              hf_hub_download(
                  repo_id='${{ env.HF_REPO }}',
                  filename='models/forex_${{ matrix.pair }}.pt',
                  local_dir='.',
                  token=os.environ['HF_TOKEN']
              )
              print('✓ Downloaded existing model for ${{ matrix.pair }}')
          except Exception as e:
              print(f'No existing model for ${{ matrix.pair }}: {e}')
          "

      - name: Fetch and train forex model
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          PAIR="${{ matrix.pair }}"
          echo "=========================================="
          echo "Processing $PAIR"
          echo "=========================================="
          
          # Fetch data
          echo "Fetching data for $PAIR..."
          python scripts/fetch_training_data.py \
            --symbols "$PAIR" \
            --output-dir "data/forex/$PAIR" \
            --period 2y \
            --asset-type forex
          
          # Store in database
          echo "Storing data for $PAIR..."
          python scripts/store_training_data.py \
            --data-dir "data/forex/$PAIR" \
            --db-file "training_${PAIR}.db" \
            --mode ${{ github.event.inputs.training_mode || 'incremental' }}
          
          # Train model (incremental if model exists)
          INCREMENTAL_FLAG=""
          if [ -f "models/forex_${PAIR}.pt" ]; then
            INCREMENTAL_FLAG="--incremental"
            echo "Using incremental training (model exists)"
          fi
          
          echo "Training model for $PAIR..."
          python scripts/train_forex_model.py \
            --pair "$PAIR" \
            --db-file "training_${PAIR}.db" \
            --output "models/forex_${PAIR}.pt" \
            --epochs ${{ github.event.inputs.epochs || '50' }} \
            --use-all-data \
            $INCREMENTAL_FLAG \
            --wandb-project ${{ env.WANDB_PROJECT }} \
            --wandb-run-name "forex-${PAIR}-$(date +%Y%m%d-%H%M)"
          
          echo "✓ Successfully trained $PAIR"

      - name: Upload trained model
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: model-forex-${{ matrix.pair }}
          path: models/forex_${{ matrix.pair }}.pt
          retention-days: 7

  push-to-huggingface:
    name: Push Models to Hugging Face
    needs: [train-stock-models, train-forex-models]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install huggingface_hub

      - name: Download all model artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-models/
          pattern: "*-models-*"
        continue-on-error: true

      - name: Download forex models
        uses: actions/download-artifact@v4
        with:
          path: downloaded-models/
          pattern: "model-forex-*"
        continue-on-error: true

      - name: Organize models
        run: |
          mkdir -p models/
          find downloaded-models/ -name "*.pt" -exec cp {} models/ \; 2>/dev/null || true
          echo "Models found:"
          ls -la models/ || echo "No models found"

      - name: Push models to Hugging Face
        if: hashFiles('models/*.pt') != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os
          from pathlib import Path
          
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          # Ensure repo exists
          try:
              api.create_repo(repo_id='${{ env.HF_REPO }}', repo_type='model', exist_ok=True)
          except:
              pass
          
          # Upload all model files
          model_files = list(Path('models').glob('*.pt'))
          print(f'Uploading {len(model_files)} models to Hugging Face...')
          
          for model_file in model_files:
              print(f'Uploading {model_file.name}...')
              try:
                  api.upload_file(
                      path_or_fileobj=str(model_file),
                      path_in_repo=f'models/{model_file.name}',
                      repo_id='${{ env.HF_REPO }}',
                      token=os.environ['HF_TOKEN']
                  )
                  print(f'✓ Uploaded {model_file.name}')
              except Exception as e:
                  print(f'✗ Failed to upload {model_file.name}: {e}')
          
          print('✓ All models uploaded to Hugging Face')
          "

      - name: Create and upload training summary
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Create summary
          cat > training-summary.md << 'EOF'
          # Training Summary - $(date +%Y-%m-%d\ %H:%M\ UTC)
          
          ## Models Trained
          
          ### Stock Models
          $(ls models/stock_*.pt 2>/dev/null | while read f; do echo "- $(basename $f)"; done || echo "- None")
          
          ### Forex Models
          $(ls models/forex_*.pt 2>/dev/null | while read f; do echo "- $(basename $f)"; done || echo "- None")
          
          ## Configuration
          - Training Mode: ${{ github.event.inputs.training_mode || 'incremental' }}
          - Epochs: ${{ github.event.inputs.epochs || '50' }}
          - Stock Count: ${{ github.event.inputs.stock_count || '5' }}
          - Run ID: ${{ github.run_id }}
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Hugging Face Repository
          https://huggingface.co/${{ env.HF_REPO }}
          
          ## Weights & Biases
          https://wandb.ai/your-username/${{ env.WANDB_PROJECT }}
          EOF
          
          # Upload summary
          python -c "
          from huggingface_hub import HfApi
          import os
          
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          try:
              api.upload_file(
                  path_or_fileobj='training-summary.md',
                  path_in_repo='training-summary.md',
                  repo_id='${{ env.HF_REPO }}',
                  token=os.environ['HF_TOKEN']
              )
              print('✓ Uploaded training summary')
          except Exception as e:
              print(f'Failed to upload summary: {e}')
          "

      - name: Create model card
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cat > README.md << 'EOF'
          ---
          license: mit
          tags:
          - finance
          - stock-prediction
          - forex
          - time-series
          - pytorch
          - ensemble-learning
          library_name: pytorch
          ---
          
          # ARA AI - Financial Prediction Models
          
          Continuously trained ensemble ML models for stock and forex prediction.
          
          ## Models
          
          - **Stock Models**: Trained on random selection of stocks every 2 hours
          - **Forex Models**: EURUSD, GBPUSD, USDJPY trained every 2 hours
          
          ## Training Schedule
          
          Models are automatically retrained every 2 hours (12 times daily) using:
          - 2 years of historical data
          - Incremental training on existing models
          - Ensemble of XGBoost, LightGBM, Random Forest, Transformers, CNN-LSTM
          
          ## Usage
          
          ```python
          from huggingface_hub import hf_hub_download
          from meridianalgo.unified_ml import UnifiedStockML
          
          # Download model
          model_path = hf_hub_download(
              repo_id="MeridianAlgo/ARA.AI",
              filename="models/stock_AAPL.pt"
          )
          
          # Load and predict
          ml = UnifiedStockML(model_path=model_path)
          prediction = ml.predict('AAPL', days=5)
          ```
          
          ## Experiment Tracking
          
          Training metrics tracked on [Weights & Biases](https://wandb.ai)
          
          ## Repository
          
          Source code: [github.com/MeridianAlgo/AraAI](https://github.com/MeridianAlgo/AraAI)
          
          ## Disclaimer
          
          These models are for educational and research purposes only. Not financial advice.
          Past performance does not guarantee future results.
          EOF
          
          # Upload model card
          python -c "
          from huggingface_hub import HfApi
          import os
          
          api = HfApi(token=os.environ['HF_TOKEN'])
          
          try:
              api.upload_file(
                  path_or_fileobj='README.md',
                  path_in_repo='README.md',
                  repo_id='${{ env.HF_REPO }}',
                  token=os.environ['HF_TOKEN']
              )
              print('✓ Uploaded model card')
          except Exception as e:
              print(f'Failed to upload model card: {e}')
          "
