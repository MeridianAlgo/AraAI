name: Lint Code

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Linting Tools
        run: |
          python -m pip install --upgrade pip
          pip install isort black ruff
      
      - name: Run isort
        run: |
          isort --check-only --diff .
        continue-on-error: true
      
      - name: Run Black
        run: |
          black --check --diff .
        continue-on-error: true
      
      - name: Run Ruff
        run: |
          ruff check .
        continue-on-error: true
      
      - name: Lint Summary
        if: always()
        run: |
          echo "Linting completed. Check individual steps for details."
      
      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Linting Failed - Run ${context.runNumber}`;
            const body = `## Code Linting Failure
            
            **Workflow Run:** [${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
            **Branch:** ${context.ref}
            **Commit:** ${context.sha.substring(0, 7)}
            **Triggered by:** ${context.eventName}
            
            ### Failure Details
            The code linting workflow failed. Please check the workflow logs for detailed error messages.
            
            ### Action Items
            - [ ] Review workflow logs
            - [ ] Fix isort issues
            - [ ] Fix Black formatting issues
            - [ ] Fix Ruff linting issues
            - [ ] Run linters locally before pushing
            
            ### Commands to Fix Locally
            \`\`\`bash
            # Fix import sorting
            isort .
            
            # Fix code formatting
            black .
            
            # Fix linting issues
            ruff check . --fix
            \`\`\`
            
            ### Links
            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'linting-failure'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Linting Failed')
            );
            
            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Another failure occurred in run [${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['linting-failure', 'automated']
              });
            }
